<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Calculator</title>
	<style>
		table {width: 361px;height: 581px;border: 1px solid;text-align: center;border-collapse: collapse;background-color: #e1e1e1;font-weight: 700;font-size: 25px;table-layout: fixed;}
		.mathematical-expression {height: 40px;padding-top: 10px;padding-left: 110px;font-size: 16px}
		.result {height: 90px;font-size: 50px;word-break:break-all;}
		table td {border: 1px solid #a9a9a9; border-width: 0 0 1px 1px;padding: 0}
		button {display: block;width:100%;height: 100%;border: 0; background: 0;font-weight: inherit;color: inherit;font-size:inherit;padding: 0;}
		tbody td:last-child {background-color: #f5933c;color: #fff;font-weight: 300;font-size: 40px}
		tbody tr:first-child {background-color: #d4d4d4;}
		tbody td[colspan] button {text-align: left; padding-left: 37px;}
		thead {background-color: #4b4b4b;text-align: right;}
		thead td {padding-right: 30px;color: #fff;}
		thead tr:first-child td{border-bottom: 0;}
		.mathematical-expression {background: url(../img/img.png) no-repeat 10px 10px;}
	</style>
</head>
<body>
	<table>
		<colgroup>
			<col style="width: 25%">
			<col style="width: 25%">
			<col style="width: 25%">
			<col>
		</colgroup>
		<thead>
			<tr>
				<td class="mathematical-expression" colspan="4" data-output="expression"></td>
			</tr>
			<tr>
				<td class="result" colspan="4" data-output="result"></td>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td><button type="button" data-btn="reset">C</button></td>
				<td><button type="button" data-symbol="plusMinus">+/-</button></td>
				<td><button type="button" data-symbol="percent">％</button></td>
				<td><button type="button" data-operator="division">÷</button></td>
			</tr>
			<tr>
				<td><button type="button" data-number="7">7</button></td>
				<td><button type="button" data-number="8">8</button></td>
				<td><button type="button" data-number="9">9</button></td>
				<td><button type="button" data-operator="times">×</button></td>
			</tr>
			<tr>
				<td><button type="button" data-number="4">4</button></td>
				<td><button type="button" data-number="5">5</button></td>
				<td><button type="button" data-number="6">6</button></td>
				<td><button type="button" data-operator="minus">-</button></td>
			</tr>
			<tr>
				<td><button type="button" data-number="1">1</button></td>
				<td><button type="button" data-number="2">2</button></td>
				<td><button type="button" data-number="3">3</button></td>
				<td><button type="button" data-operator="plus">+</button></td>
			</tr>
			<tr>
				<td colspan="2"><button type="button" data-number="zero">0</button></td>
				<td><button type="button" data-symbol="dot">.</button></td>
				<td><button type="button" data-btn="calculate">=</button></td>
			</tr>
		</tbody>
  </table>
<script>
// https://stackoverflow.com/questions/2901102/how-to-print-a-number-with-commas-as-thousands-separators-in-javascript
function numberWithCommas(x) {
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
const Calculator = {
  status: 0, // 0: initial, 1: input, 2: operator, 3: done
  acc: 0,
  input: '',
  expr: '',
  isPercentage: false,
  lastOperand: 0,
  lastOperator: '',
  el: {
    input: [
      ...document.querySelectorAll('[data-number]'),
      document.querySelector('[data-symbol=dot]'),
      document.querySelector('[data-symbol=plusMinus]'),
      document.querySelector('[data-symbol=percent]'),
    ],
    operator: [...document.querySelectorAll('[data-operator]')],
    calculate: document.querySelector('[data-btn=calculate]'),
    reset: document.querySelector('[data-btn=reset]'),
    screen: document.querySelector('[data-output=result]'),
    exprScreen: document.querySelector('[data-output=expression]'),
  },

  display(){
    const {screen,exprScreen} = this.el;
    screen.textContent = this.input ? `${numberWithCommas(this.input)}` : `${numberWithCommas(this.acc)}`;
    exprScreen.textContent = this.expr;
  },

  compute(operator, operand){
    switch(operator){
      case '+': return this.acc + operand;
      case '-': return this.acc - operand;
      case '×': return this.acc * operand;
      case '÷': return this.acc / operand;
      default: return null;
    }
  },

  makeExpr(){
    console.log('f')
    switch(this.status){
      case 0: return;
      break;
      case 1:
        this.expr += `${this.input} ${this.lastOperator}`;
      break;
      default: return '';
    }
  },

  inputHandler(e){
    const value = e.target.textContent;
    switch(value){
      case '.':
        if(this.input.includes('.')) return;
        this.input = !this.input ? '0.' : this.input + '.';
      break;
      case '+/-':
				if(this.status === 0) return;
        this.input = this.input
					? (parseFloat(this.input) * -1).toString()
					: this.acc * -1; // 연산 도중에 입력 없이 누르면 현재 누적 값이 입력 값이 됌
      break;
      case '％':
        if(!this.lastOperator) {
          this.input = '0';
        } else {
          this.input = this.input ? this.input/100 : this.acc/100;
          if(this.lastOperator === '+'|| this.lastOperator === '-') {
            this.input *= this.acc;
          }
          this.isPercentage = true;
        }
      break;
      default: // 0~9
        if(this.input === '0') this.input = '';
        this.input += value;
    }
    this.display();
    this.status = 1;
  },
  
  operatorHandler(e){    
    const operand = parseFloat(this.input);
    const operator = e.target.textContent;
    
    switch(this.status) {
      case 0: return; // 연산 기호부터 누른 경우
      case 1:
        this.acc = this.lastOperator ? this.compute(this.lastOperator, operand) : operand;
        this.lastOperand = operand;
        this.input = '';
      break;
      case 3:
        this.input = this.acc;
      break;
      default: return;
    }

    this.lastOperator = operator; // 직전 연산 기호 갱신
    this.makeExpr();
    this.display();
    this.status = 2;
  },

  calcHandler(){
		let operand = parseFloat(this.input);

    switch(this.status) {
      case 0: return;
      case 1:
        this.acc = this.lastOperand ? this.compute(this.lastOperator, operand) : operand;
        this.lastOperand = operand;
      break;
      case 2:
        if(!operand) operand = this.acc;
        this.acc = this.compute(this.lastOperator, operand);
        this.lastOperand = operand;
      break;
      case 3:
        if(!this.lastOperator) return;
        this.acc = this.compute(this.lastOperator, this.lastOperand);
      break;
      default: return;
    }
		
		this.input = '';
    this.display();
    this.status = 3;
  },

  addEvents(){
    const {input,operator,calculate,reset} = this.el;
    input.forEach(button => button.addEventListener('click', e => this.inputHandler(e)));
    operator.forEach(button => button.addEventListener('click', e => this.operatorHandler(e)));
    calculate.addEventListener('click', () => this.calcHandler());
    reset.addEventListener('click', () => this.clearHandler());
  },

  clearHandler(){
    this.status = 0;
    this.acc = 0;
    this.input = '';
    this.expr = '';
    this.isPercentage = false;
    this.lastOperand = null;
    this.lastOperator = '';
    this.display();
  },

  init(){
    this.addEvents();
    this.clearHandler()
  }
};
Calculator.init();

/* TODO
- expr의 음수 값 ( ) 추가 및 로직 분리?
- = 연산 이후의 인풋 핸들러 수정
- 키보드 조작
- 소수점 4자리로 fix
- 코드 리팩토링, 파일 분리
- 디버깅용 log 함수
*/
</script>
</body>
</html>